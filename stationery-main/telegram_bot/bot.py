import logging
import asyncio
from telegram import Bot, InlineKeyboardButton, InlineKeyboardMarkup
from django.conf import settings
from asgiref.sync import sync_to_async

logger = logging.getLogger(__name__)

class TelegramBot:
    def __init__(self):
        token = getattr(settings, 'TELEGRAM_BOT_TOKEN', None)
        if not token:
            self.bot = None
            logger.warning("TELEGRAM_BOT_TOKEN not configured")
        else:
            self.bot = Bot(token=token)
        self.admin_chat_id = getattr(settings, 'TELEGRAM_ADMIN_CHAT_ID', None)
    
    async def send_payment_notification(self, order):
        """–û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–æ–≤–æ–º –ø–ª–∞—Ç–µ–∂–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É"""
        if not self.bot or not self.admin_chat_id:
            logger.warning("Telegram bot not configured, skipping notification")
            return
            
        try:
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
            from datetime import datetime, timedelta
            
            # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º—è –≤ –ö—ã—Ä–≥—ã–∑—Å—Ç–∞–Ω (+6 UTC)
            kg_time = order.created_at + timedelta(hours=6)
            
            message = f"""ü§ñ –ë–æ—Ç KG Style:
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
üí∞ –ù–û–í–´–ô –ó–ê–ö–ê–ó
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
üì¶ –ó–∞–∫–∞–∑: #{order.id}
üí∞ –°—É–º–º–∞: {order.total_price} —Å–æ–º
üîñ –ö–æ–¥: {order.qr_code}
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
üë§ –ö–ª–∏–µ–Ω—Ç:
‚Ä¢ –ò–º—è: {order.first_name} {order.last_name}
‚Ä¢ Email: {order.email}
‚Ä¢ –¢–µ–ª: {order.phone}
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
üìç –î–æ—Å—Ç–∞–≤–∫–∞:
‚Ä¢ –ì–æ—Ä–æ–¥: {order.city}
‚Ä¢ –ê–¥—Ä–µ—Å: {order.address}
‚Ä¢ –ò–Ω–¥–µ–∫—Å: {order.postal_code or '–ù–µ —É–∫–∞–∑–∞–Ω'}
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚è∞ –í—Ä–µ–º—è: {kg_time.strftime('%d.%m.%Y %H:%M')} (KG)
üõí –¢–æ–≤–∞—Ä—ã: {self.get_order_items(order)}
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

üîó –ê–¥–º–∏–Ω–∫–∞: http://127.0.0.1:8000/admin/shop/order/{order.id}/change/
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"""
            
            # –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è/–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è
            keyboard = [
                [
                    InlineKeyboardButton("‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å", callback_data=f"confirm_payment_{order.id}"),
                    InlineKeyboardButton("‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å", callback_data=f"reject_payment_{order.id}")
                ]
            ]
            reply_markup = InlineKeyboardMarkup(keyboard)
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            await self.bot.send_message(
                chat_id=self.admin_chat_id,
                text=message,
                reply_markup=reply_markup
            )
            
            logger.info(f"–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–ª–∞—Ç–µ–∂–µ –¥–ª—è –∑–∞–∫–∞–∑–∞ #{order.id}")
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø–ª–∞—Ç–µ–∂–µ: {e}")
    
    def get_order_items(self, order):
        """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ –∑–∞–∫–∞–∑–∞"""
        items = []
        for item in order.items.all()[:3]:  # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 3 —Ç–æ–≤–∞—Ä–∞
            items.append(f"{item.product.name}")
        if order.items.count() > 3:
            items.append(f"–∏ –µ—â–µ {order.items.count() - 3} —à—Ç.")
        return ", ".join(items)
    
    async def send_payment_confirmation(self, order):
        """–û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É –æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –æ–ø–ª–∞—Ç—ã"""
        try:
            message = f"""‚úÖ –í–∞—à –ø–ª–∞—Ç–µ–∂ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω!
            
–ó–∞–∫–∞–∑ #{order.id} –Ω–∞ —Å—É–º–º—É {order.total_price} —Å–æ–º –æ–ø–ª–∞—á–µ–Ω.
–í–∞—à –∑–∞–∫–∞–∑ –≥–æ—Ç–æ–≤–∏—Ç—Å—è –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ.

–°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–∫—É–ø–∫—É! üõçÔ∏è"""
            
            # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É –∫–ª–∏–µ–Ω—Ç—É –≤ Telegram, –µ—Å–ª–∏ —É –Ω–µ–≥–æ –µ—Å—Ç—å chat_id
            # –ü–æ–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—É
            
            logger.info(f"–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã –¥–ª—è –∑–∞–∫–∞–∑–∞ #{order.id}")
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã: {e}")

# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞
telegram_bot = TelegramBot()

# –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –æ–±–µ—Ä—Ç–∫–∏
def send_payment_notification(order):
    """–°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±–µ—Ä—Ç–∫–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø–ª–∞—Ç–µ–∂–µ"""
    if telegram_bot.bot and telegram_bot.admin_chat_id:
        asyncio.run(telegram_bot.send_payment_notification(order))

def send_payment_confirmation(order):
    """–°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±–µ—Ä—Ç–∫–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã"""
    if telegram_bot.bot and telegram_bot.admin_chat_id:
        asyncio.run(telegram_bot.send_payment_confirmation(order))
