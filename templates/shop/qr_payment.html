{% extends 'base.html' %}
{% load media_url %}

{% block title %}QR-код оплаты заказа #{{ order.id }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-qrcode"></i> Оплата по QR-коду
                    </h4>
                </div>
                <div class="card-body text-center">
                    <!-- Информация о заказе -->
                    <div class="alert alert-info mb-4">
                        <h5>Заказ #{{ order.id }}</h5>
                        <p class="mb-1"><strong>Сумма к оплате:</strong> {{ order.total_price }} сом</p>
                        <p class="mb-0"><strong>Уникальный код:</strong> {{ order.qr_code }}</p>
                    </div>

                    <!-- QR-код -->
                    <div class="mb-4">
                        {% if bank_account.qr_code_image %}
                            <img src="{{ bank_account.qr_code_image.url|media_url }}" 
                                 alt="QR-код для оплаты" 
                                 class="img-fluid" 
                                 style="max-width: 300px; border: 2px solid #ddd; border-radius: 8px;">
                        {% else %}
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i> QR-код временно недоступен
                            </div>
                        {% endif %}
                    </div>

                    <!-- Инструкция -->
                    <div class="alert alert-light text-left">
                        <h6><i class="fas fa-info-circle"></i> Как оплатить:</h6>
                        <ol class="mb-0">
                            <li>Откройте мобильное приложение вашего банка</li>
                            <li>Выберите "Оплатить по QR-коду"</li>
                            <li>Наведите камеру на QR-код выше</li>
                            <li>Убедитесь, что сумма: <strong>{{ order.total_price }} сом</strong></li>
                            <li>В назначении платежа укажите: <strong>{{ payment_description }}</strong></li>
                            <li>Подтвердите платеж</li>
                        </ol>
                    </div>

                    <!-- Реквизиты -->
                    <div class="bg-light p-3 rounded mb-4">
                        <h6><i class="fas fa-university"></i> Реквизиты:</h6>
                        <p class="mb-1"><strong>Банк:</strong> {{ bank_account.bank_name }}</p>
                        <p class="mb-1"><strong>Счет:</strong> {{ bank_account.account_number }}</p>
                        <p class="mb-0"><strong>Назначение:</strong> {{ payment_description }}</p>
                    </div>

                    <!-- Предупреждение -->
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> 
                        <strong>Важно!</strong> Обязательно укажите в назначении платежа код <strong>{{ order.qr_code }}</strong>, 
                        иначе мы не сможем идентифицировать ваш платеж.
                    </div>

                    <!-- Кнопки -->
                    <div class="d-flex justify-content-between gap-2">
                        <a href="{% url 'shop:order_detail' order.pk %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Вернуться к заказу
                        </a>
                        <button onclick="notifyPaymentAndCheckStatus()" class="btn btn-success">
                            <i class="fas fa-check"></i> Я оплатил(а)
                        </button>
                    </div>
                </div>
            </div>

            <!-- Статус проверки -->
            <div id="payment-status" class="mt-3" style="display: none;">
                <div class="alert alert-info">
                    <i class="fas fa-spinner fa-spin"></i> Проверяем статус оплаты...
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function notifyPaymentAndCheckStatus() {
    const statusDiv = document.getElementById('payment-status');
    statusDiv.style.display = 'block';
    statusDiv.innerHTML = `
        <div class="alert alert-info">
            <i class="fas fa-spinner fa-spin"></i> 
            Отправляем уведомление администратору и проверяем статус оплаты...
        </div>
    `;
    
    // Сначала отправляем уведомление
    fetch(`/api/orders/{{ order.id }}/notify-payment/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            statusDiv.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-bell"></i> 
                    ✅ Уведомление отправлено администратору!
                    <br>Проверяем статус оплаты...
                </div>
            `;
            
            // Затем начинаем проверку статуса
            checkPaymentStatus();
        } else {
            statusDiv.innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i> 
                    Не удалось отправить уведомление, но проверяем статус...
                </div>
            `;
            checkPaymentStatus();
        }
    })
    .catch(error => {
        console.error('Ошибка отправки уведомления:', error);
        statusDiv.innerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i> 
                Ошибка отправки, но проверяем статус...
            </div>
        `;
        checkPaymentStatus();
    });
}

function checkPaymentStatus() {
    const statusDiv = document.getElementById('payment-status');
    
    // Проверяем статус оплаты каждые 5 секунд
    const interval = setInterval(() => {
        fetch(`/api/orders/{{ order.id }}/status/`)
            .then(response => response.json())
            .then(data => {
                if (data.paid) {
                    clearInterval(interval);
                    statusDiv.innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i> 
                            Оплата подтверждена! Перенаправляем на страницу заказа...
                        </div>
                    `;
                    setTimeout(() => {
                        window.location.href = "{% url 'shop:order_detail' order.pk %}";
                    }, 2000);
                }
            })
            .catch(error => {
                console.error('Ошибка проверки статуса:', error);
            });
    }, 5000);
    
    // Останавливаем проверку через 5 минут
    setTimeout(() => {
        clearInterval(interval);
        statusDiv.innerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i> 
                Проверка статуса остановлена. Если вы оплатили, обновите страницу позже.
            </div>
        `;
    }, 300000);
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
