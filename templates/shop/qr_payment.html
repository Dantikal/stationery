{% extends 'base.html' %}
{% load media_url %}

{% block title %}QR-–∫–æ–¥ –æ–ø–ª–∞—Ç—ã –∑–∞–∫–∞–∑–∞ #{{ order.id }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-qrcode"></i> –û–ø–ª–∞—Ç–∞ –ø–æ QR-–∫–æ–¥—É
                    </h4>
                </div>
                <div class="card-body text-center">
                    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–∫–∞–∑–µ -->
                    <div class="alert alert-info mb-4">
                        <h5>–ó–∞–∫–∞–∑ #{{ order.id }}</h5>
                        <p class="mb-1"><strong>–°—É–º–º–∞ –∫ –æ–ø–ª–∞—Ç–µ:</strong> {{ order.total_price }} —Å–æ–º</p>
                        <p class="mb-0"><strong>–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥:</strong> {{ order.qr_code }}</p>
                    </div>

                    <!-- QR-–∫–æ–¥ -->
                    <div class="mb-4">
                        {% if bank_account.get_qr_url %}
                            <img src="{{ bank_account.get_qr_url }}" 
                                 alt="QR-–∫–æ–¥ –¥–ª—è –æ–ø–ª–∞—Ç—ã" 
                                 class="img-fluid" 
                                 style="max-width: 300px; border: 2px solid #ddd; border-radius: 8px;">
                        {% else %}
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i> QR-–∫–æ–¥ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
                            </div>
                        {% endif %}
                    </div>

                    <!-- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è -->
                    <div class="alert alert-light text-left">
                        <h6><i class="fas fa-info-circle"></i> –ö–∞–∫ –æ–ø–ª–∞—Ç–∏—Ç—å:</h6>
                        <ol class="mb-0">
                            <li>–û—Ç–∫—Ä–æ–π—Ç–µ –º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤–∞—à–µ–≥–æ –±–∞–Ω–∫–∞</li>
                            <li>–í—ã–±–µ—Ä–∏—Ç–µ "–û–ø–ª–∞—Ç–∏—Ç—å –ø–æ QR-–∫–æ–¥—É"</li>
                            <li>–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR-–∫–æ–¥ –≤—ã—à–µ</li>
                            <li>–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å—É–º–º–∞: <strong>{{ order.total_price }} —Å–æ–º</strong></li>
                            <li>–í –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞ —É–∫–∞–∂–∏—Ç–µ: <strong>{{ payment_description }}</strong></li>
                            <li>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–ª–∞—Ç–µ–∂</li>
                        </ol>
                    </div>

                    <!-- –†–µ–∫–≤–∏–∑–∏—Ç—ã -->
                    <div class="bg-light p-3 rounded mb-4">
                        <h6><i class="fas fa-university"></i> –†–µ–∫–≤–∏–∑–∏—Ç—ã:</h6>
                        <p class="mb-1"><strong>–ë–∞–Ω–∫:</strong> {{ bank_account.bank_name }}</p>
                        <p class="mb-1"><strong>–°—á–µ—Ç:</strong> {{ bank_account.account_number }}</p>
                        <p class="mb-0"><strong>–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:</strong> {{ payment_description }}</p>
                    </div>

                    <!-- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ -->
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> 
                        <strong>–í–∞–∂–Ω–æ!</strong> –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–∫–∞–∂–∏—Ç–µ –≤ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞ –∫–æ–¥ <strong>{{ order.qr_code }}</strong>, 
                        –∏–Ω–∞—á–µ –º—ã –Ω–µ —Å–º–æ–∂–µ–º –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –≤–∞—à –ø–ª–∞—Ç–µ–∂.
                    </div>

                    <!-- –ö–Ω–æ–ø–∫–∏ -->
                    <div class="d-flex justify-content-between gap-2">
                        <a href="{% url 'shop:order_detail' order.pk %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –∑–∞–∫–∞–∑—É
                        </a>
                        <button onclick="notifyPaymentAndCheckStatus()" class="btn btn-success">
                            <i class="fas fa-check"></i> –Ø –æ–ø–ª–∞—Ç–∏–ª(–∞)
                        </button>
                    </div>
                </div>
            </div>

            <!-- –°—Ç–∞—Ç—É—Å –ø—Ä–æ–≤–µ—Ä–∫–∏ -->
            <div id="payment-status" class="mt-3" style="display: none;">
                <div class="alert alert-info">
                    <i class="fas fa-spinner fa-spin"></i> –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã...
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function notifyPaymentAndCheckStatus() {
    const statusDiv = document.getElementById('payment-status');
    statusDiv.style.display = 'block';
    statusDiv.innerHTML = `
        <div class="alert alert-info">
            <i class="fas fa-spinner fa-spin"></i> 
            –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã...
        </div>
    `;
    
    // –°–Ω–∞—á–∞–ª–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    fetch(`/api/orders/{{ order.id }}/notify-payment/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            statusDiv.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-bell"></i> 
                    ‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É!
                    <br>–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã...
                </div>
            `;
            
            // –ó–∞—Ç–µ–º –Ω–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Ç–∞—Ç—É—Å–∞
            checkPaymentStatus();
        } else {
            statusDiv.innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i> 
                    –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, –Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å...
                </div>
            `;
            checkPaymentStatus();
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:', error);
        statusDiv.innerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i> 
                –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏, –Ω–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å...
            </div>
        `;
        checkPaymentStatus();
    });
}

function checkPaymentStatus() {
    const statusDiv = document.getElementById('payment-status');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
    const interval = setInterval(() => {
        fetch(`/api/orders/{{ order.id }}/status/`)
            .then(response => response.json())
            .then(data => {
                console.log('–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞:', data); // –û—Ç–ª–∞–¥–∫–∞
                if (data.paid || data.status === 'confirmed') {
                    clearInterval(interval);
                    statusDiv.innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i> 
                            ‚úÖ –û–ø–ª–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞! –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∑–∞–∫–∞–∑–∞...
                        </div>
                    `;
                    setTimeout(() => {
                        window.location.href = "{% url 'shop:order_detail' order.pk %}";
                    }, 2000);
                } else if (data.status === 'processing') {
                    // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å processing (–≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ)
                    console.log('–°—Ç–∞—Ç—É—Å processing - –∂–¥–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è');
                    statusDiv.innerHTML = `
                        <div class="alert alert-info">
                            <i class="fas fa-clock"></i> 
                            üîÑ –ó–∞–∫–∞–∑ –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º...
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞:', error);
            });
    }, 5000);
    
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç
    setTimeout(() => {
        clearInterval(interval);
        statusDiv.innerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i> 
                –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞. –ï—Å–ª–∏ –≤—ã –æ–ø–ª–∞—Ç–∏–ª–∏, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ–∑–∂–µ.
            </div>
        `;
    }, 300000);
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
